name: Test, Build & Release

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
      - Cargo.toml
      - Cargo.lock
      - .github/workflows/release.yml
  push:
    tags: [ '[0-9]+.[0-9]+.[0-9]+' ]

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

env:
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  CARGO_TERM_COLOR: always
  RUSTUP_MAX_RETRIES: 10
  RUST_BACKTRACE: 1

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-24.04
    steps:
    -
      name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
    -
      name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561  # v1
      with:
        components: rustfmt, clippy
        toolchain: stable
    -
      name: Cache dependencies
      uses: swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2
    -
      name: Check formatting
      run: cargo fmt --all -- --check
    -
      name: Check lints
      run: cargo clippy --all-targets -- -D warnings
    -
      name: Run tests
      run: cargo test

  build:
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    name: Build for ${{ matrix.target }}
    needs: test
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            artifact_name: shh-x86_64-unknown-linux-gnu.tar.gz
          - target: aarch64-unknown-linux-gnu
            artifact_name: shh-aarch64-unknown-linux-gnu.tar.gz
    steps:
      -
        name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
      -
        name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561  # v1
        with:
          toolchain: stable
      -
        name: Cache dependencies
        uses: swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5  # v2.8.2
      -
        name: Install cross-rs
        uses: taiki-e/install-action@a983ca795126a4be4e8a44879ac5c4c3ef66cae1  # v2.65.11
        with:
          tool: cross@0.2.5
      -
        name: Build binary
        run: cross build --release --target ${{ matrix.target }}
      -
        name: Package artifact
        run: |
          cd target/${{ matrix.target }}/release
          tar czvf ${{ matrix.artifact_name }} shh
          mv ${{ matrix.artifact_name }} $GITHUB_WORKSPACE/
      -
        name: Upload artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ github.workspace }}/${{ matrix.artifact_name }}

  release:
    if: startsWith(github.ref, 'refs/tags/')
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      -
        name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
      -
        name: Download artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7.0.0
        with:
          path: artifacts
          merge-multiple: true
      -
        name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }}" \
            --generate-notes \
            artifacts/*
